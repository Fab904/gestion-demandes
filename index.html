<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Demandes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e0e0e0;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .list-section {
            padding: 30px;
            overflow-y: auto;
            max-height: 800px;
        }

        .list-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .demande-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .demande-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .demande-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .demande-projet {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }

        .voyant {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .voyant.vert {
            background: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        .voyant.gris {
            background: #9E9E9E;
        }

        .voyant.rouge {
            background: #f44336;
            box-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
            animation: pulse 1.5s infinite;
        }

        .gyrophare {
            font-size: 1.5em;
            margin-left: 10px;
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .demande-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .info-item {
            font-size: 0.9em;
        }

        .info-label {
            color: #666;
            font-weight: 600;
        }

        .info-value {
            color: #333;
            margin-top: 3px;
        }

        .demande-notes {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.9em;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .demande-notes-label {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .demande-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

        .btn-edit:hover {
            background: #1976D2;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .modal-body {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #667eea;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #5568d3;
        }

        .modal-btn-secondary {
            background: #e0e0e0;
            color: #333;
        }

        .modal-btn-secondary:hover {
            background: #d0d0d0;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .form-section {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gestion des Demandes</h1>
            <p>Syst√®me de suivi et d'alertes automatiques</p>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2>Nouvelle Demande</h2>
                
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                    <strong style="color: #856404;">üß™ Test Notifications</strong><br>
                    <button type="button" onclick="testNotificationWindows()" style="margin-top: 10px; padding: 10px; background: #ffc107; border: none; border-radius: 6px; cursor: pointer; width: 100%; font-weight: 600;">
                        üîî Tester notification Windows
                    </button>
                    <small style="color: #856404; display: block; margin-top: 5px;">
                        Cliquez pour voir si les notifications Windows fonctionnent
                    </small>
                </div>

                <form id="demandeForm" onsubmit="return handleFormSubmit(event)">
                    <div class="form-group">
                        <label for="projet">Projet</label>
                        <input type="text" id="projet" required placeholder="Nom du projet" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="dateDemande">Date de la demande</label>
                        <input type="text" id="dateDemande" required placeholder="jj/mm/26" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="qui">QUI (Destinataire)</label>
                        <select id="qui" required onchange="handleQuiChange()">
                            <option value="">-- S√©lectionner ou ajouter --</option>
                            <option value="custom">‚ûï Nouveau destinataire</option>
                        </select>
                    </div>

                    <div class="form-group" id="customQuiGroup" style="display: none;">
                        <label for="customQui">Nom du nouveau destinataire</label>
                        <input type="text" id="customQui" placeholder="Entrez le nom puis validez le formulaire" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="dateDemandee">Date demand√©e</label>
                        <input type="text" id="dateDemandee" required placeholder="jj/mm/26" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="dateValidee">Date valid√©e</label>
                        <input type="text" id="dateValidee" placeholder="jj/mm/26" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="livraison">
                            <label for="livraison">Livraison effectu√©e</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" placeholder="Ajoutez des notes ou commentaires..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 1em; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">‚ûï Ajouter la demande</button>
                    <button type="button" class="btn" id="cancelBtn" style="display: none; background: #9E9E9E; margin-top: 10px;" onclick="cancelEdit()">‚úñÔ∏è Annuler</button>
                </form>
            </div>

            <div class="list-section">
                <h2>Liste des Demandes</h2>
                <div id="demandesList"></div>
            </div>
        </div>
    </div>

    <!-- Modal pour les alertes -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Donn√©es stock√©es localement
        let demandes = JSON.parse(localStorage.getItem('demandes')) || [];
        let destinataires = JSON.parse(localStorage.getItem('destinataires')) || [];
        let editingId = null;

        // VIDER LES DONN√âES AU PREMIER CHARGEMENT (√† supprimer apr√®s le premier test)
        // localStorage.removeItem('demandes');
        // localStorage.removeItem('destinataires');
        // localStorage.removeItem('notificationsEnvoyees');
        // localStorage.removeItem('lastAlertCheck');

        // Initialisation
        updateQuiSelect();

        // Demander la permission pour les notifications AVEC INSISTANCE
        async function demanderPermissionNotifications() {
            if ('Notification' in window) {
                console.log('üîî Demande de permission...');
                console.log('Permission avant:', Notification.permission);
                
                if (Notification.permission === 'default') {
                    try {
                        // FORCER la demande avec un d√©lai
                        const permission = await Notification.requestPermission();
                        console.log('Permission apr√®s:', permission);
                        
                        if (permission === 'granted') {
                            console.log('‚úÖ Permission accord√©e !');
                            // Notification de test SIMPLE
                            try {
                                const testNotif = new Notification('‚úÖ Notifications activ√©es !', {
                                    body: 'Les alertes Windows fonctionnent maintenant.',
                                    requireInteraction: false,
                                    silent: false
                                });
                                console.log('‚úÖ Notification de test envoy√©e');
                            } catch (e) {
                                console.error('‚ùå Erreur notification test:', e);
                            }
                        } else {
                            console.error('‚ùå Permission refus√©e');
                            alert('‚ö†Ô∏è Vous devez AUTORISER les notifications !\n\nSans cela, vous ne recevrez PAS d\'alertes Windows.\n\nSi la popup ne s\'affiche pas :\n1. Utilisez Firefox au lieu d\'Edge\n2. OU h√©bergez le fichier sur un serveur web');
                        }
                        return permission === 'granted';
                    } catch (error) {
                        console.error('‚ùå Erreur lors de la demande:', error);
                        alert('‚ö†Ô∏è Edge bloque la demande de permission pour les fichiers locaux.\n\nSOLUTIONS :\n1. Utilisez FIREFOX (recommand√©)\n2. OU je vous fournis une version h√©berg√©e en ligne');
                        return false;
                    }
                } else if (Notification.permission === 'denied') {
                    console.error('‚ùå Notifications bloqu√©es');
                    alert('‚ö†Ô∏è Les notifications sont BLOQU√âES !\n\nDans Edge, les fichiers file:/// ne peuvent pas demander de permission.\n\n‚úÖ SOLUTION : Utilisez FIREFOX');
                    return false;
                } else {
                    console.log('‚úÖ Permission d√©j√† accord√©e');
                    return true;
                }
            } else {
                alert('‚ùå Navigateur non support√©');
                return false;
            }
        }

        // DEMANDER LA PERMISSION AU CHARGEMENT
        if ('Notification' in window) {
            console.log('üìç Initialisation notifications...');
            console.log('Permission initiale:', Notification.permission);
            
            if (Notification.permission === 'default') {
                // Afficher un message pour que l'utilisateur clique
                setTimeout(() => {
                    if (confirm('üîî Cette application a besoin de votre autorisation pour envoyer des notifications Windows.\n\nVoulez-vous activer les notifications maintenant ?')) {
                        demanderPermissionNotifications();
                    } else {
                        alert('‚ö†Ô∏è Sans notifications, vous ne serez pas alert√© automatiquement.\n\nVous pouvez les activer plus tard en cliquant sur le bouton jaune.');
                    }
                }, 1000);
            } else if (Notification.permission === 'denied') {
                setTimeout(() => {
                    alert('‚ö†Ô∏è PROBL√àME : Edge bloque les notifications pour les fichiers file:///\n\n‚úÖ SOLUTION SIMPLE :\nUtilisez FIREFOX au lieu d\'Edge.\n\nFirefox autorise les notifications pour les fichiers locaux.');
                }, 1000);
            }
        } else {
            alert('‚ùå Votre navigateur ne supporte pas les notifications.');
        }

        // Syst√®me de suivi des notifications envoy√©es
        function getNotificationsEnvoyees() {
            const stored = localStorage.getItem('notificationsEnvoyees');
            if (!stored) return {};
            
            const data = JSON.parse(stored);
            const today = new Date().toDateString();
            
            // Si la date stock√©e n'est pas aujourd'hui, r√©initialiser
            if (data.date !== today) {
                return {};
            }
            
            return data.notifications || {};
        }

        function saveNotificationEnvoyee(demandeId, type) {
            const today = new Date().toDateString();
            const notifications = getNotificationsEnvoyees();
            
            if (!notifications[demandeId]) {
                notifications[demandeId] = [];
            }
            
            if (!notifications[demandeId].includes(type)) {
                notifications[demandeId].push(type);
            }
            
            localStorage.setItem('notificationsEnvoyees', JSON.stringify({
                date: today,
                notifications: notifications
            }));
        }

        function dejaEnvoyee(demandeId, type) {
            const notifications = getNotificationsEnvoyees();
            return notifications[demandeId] && notifications[demandeId].includes(type);
        }

        // V√©rifier toutes les alertes et envoyer les notifications
        function verifierEtEnvoyerAlertes() {
            demandes.forEach(demande => {
                const alerte = checkAlerteForDemande(demande);
                
                if (alerte && !dejaEnvoyee(alerte.demandeId, alerte.type)) {
                    // Envoyer l'alerte
                    showAlert(alerte.titre, alerte.message, alerte.projet, alerte.qui);
                    
                    // Marquer comme envoy√©e
                    saveNotificationEnvoyee(alerte.demandeId, alerte.type);
                }
            });
        }

        // Calculer le temps jusqu'√† 9h00 du matin
        function getMillisecondsUntil9AM() {
            const now = new Date();
            const next9AM = new Date();
            next9AM.setHours(9, 0, 0, 0);
            
            // Si on est d√©j√† pass√© 9h aujourd'hui, programmer pour demain 9h
            if (now >= next9AM) {
                next9AM.setDate(next9AM.getDate() + 1);
            }
            
            return next9AM - now;
        }

        // Programmer la v√©rification quotidienne √† 9h
        function programmerVerificationQuotidienne() {
            const delai = getMillisecondsUntil9AM();
            
            setTimeout(() => {
                verifierEtEnvoyerAlertes();
                
                // Re-programmer pour le lendemain
                setInterval(() => {
                    verifierEtEnvoyerAlertes();
                }, 24 * 60 * 60 * 1000); // Toutes les 24h
                
            }, delai);
        }

        // V√©rifier imm√©diatement √† l'ouverture SI on n'a pas d√©j√† v√©rifi√© aujourd'hui
        function verificationInitiale() {
            const lastCheck = localStorage.getItem('lastAlertCheck');
            const today = new Date().toDateString();
            
            if (lastCheck !== today) {
                verifierEtEnvoyerAlertes();
                localStorage.setItem('lastAlertCheck', today);
            }
        }

        // Lancer le syst√®me de v√©rification
        verificationInitiale();
        programmerVerificationQuotidienne();

        // FONCTION DE TEST DES NOTIFICATIONS WINDOWS
        async function testNotificationWindows() {
            console.log('üß™ Test de notification lanc√©...');
            console.log('Permission actuelle:', Notification.permission);
            
            if ('Notification' in window) {
                if (Notification.permission === 'granted') {
                    try {
                        console.log('‚úÖ Permission accord√©e, envoi de la notification...');
                        
                        const notif = new Notification('üß™ Test - Notification Windows', {
                            body: 'Si vous voyez ceci EN BAS √Ä DROITE de votre √©cran (pas dans Edge), √ßa fonctionne !',
                            // PAS d'ic√¥ne pour √©viter l'erreur SVG
                            requireInteraction: true,
                            silent: false,
                            tag: 'test-' + Date.now(),
                            timestamp: Date.now()
                        });
                        
                        notif.onclick = function() {
                            alert('‚úÖ Notification Windows cliqu√©e !\n\nSi cette alerte appara√Æt apr√®s avoir cliqu√© sur la notification EN DEHORS du navigateur, tout fonctionne parfaitement !');
                            window.focus();
                            this.close();
                        };
                        
                        console.log('‚úÖ Notification cr√©√©e avec succ√®s');
                        alert('‚úÖ Notification de test envoy√©e !\n\nRegardez EN BAS √Ä DROITE de votre √©cran Windows (pas dans Edge).\n\nSi vous ne la voyez pas :\n- Ouvrez le Centre de notifications Windows (Win + A)\n- V√©rifiez la Console (F12) pour les erreurs');
                        
                    } catch (error) {
                        console.error('‚ùå Erreur:', error);
                        alert('‚ùå Erreur lors de la cr√©ation de la notification :\n\n' + error.message + '\n\nOuvrez la Console (F12) pour plus de d√©tails.');
                    }
                } else if (Notification.permission === 'denied') {
                    alert('‚ùå Les notifications sont BLOQU√âES !\n\nDans Edge :\n1. Cliquez sur üîí dans la barre d\'adresse\n2. Cherchez "Notifications"\n3. S√©lectionnez "Autoriser"\n4. Rechargez la page (F5)');
                } else {
                    console.log('‚ö†Ô∏è Permission non accord√©e, demande...');
                    const permission = await Notification.requestPermission();
                    console.log('Nouvelle permission:', permission);
                    
                    if (permission === 'granted') {
                        testNotificationWindows(); // R√©essayer
                    } else {
                        alert('‚ùå Vous avez refus√© les notifications.\n\nPour les activer :\n1. Rechargez la page (F5)\n2. Cliquez "Autoriser" quand demand√©');
                    }
                }
            } else {
                alert('‚ùå Votre navigateur ne supporte pas les notifications.');
            }
        }

        // Obtenir l'ann√©e en cours sur 2 chiffres
        function getCurrentYear() {
            return new Date().getFullYear().toString().substring(2);
        }

        // Normaliser la date : ajouter les z√©ros et l'ann√©e si n√©cessaire
        function normalizeDate(input) {
            if (!input) return '';
            
            let parts = input.split('/');
            if (parts.length === 0) return '';
            
            // Normaliser jour
            let jour = parts[0] ? parts[0].trim() : '';
            if (jour && jour.length === 1) jour = '0' + jour;
            
            // Normaliser mois
            let mois = parts[1] ? parts[1].trim() : '';
            if (mois && mois.length === 1) mois = '0' + mois;
            
            // Normaliser ann√©e
            let annee = parts[2] ? parts[2].trim() : getCurrentYear();
            if (annee.length === 1) annee = '0' + annee;
            
            // Retourner la date normalis√©e
            if (jour && mois) {
                return `${jour}/${mois}/${annee}`;
            }
            return input;
        }

        // Ajouter des √©couteurs sur les champs de date pour auto-compl√©tion
        ['dateDemande', 'dateDemandee', 'dateValidee'].forEach(fieldId => {
            const field = document.getElementById(fieldId);
            field.addEventListener('blur', function() {
                this.value = normalizeDate(this.value);
            });
        });

        // Emp√™cher la soumission du formulaire avec la touche Entr√©e
        function preventEnterSubmit(event) {
            if (event.keyCode === 13 || event.which === 13) {
                event.preventDefault();
                // Passer au champ suivant ou normaliser la date
                if (event.target.type === 'text') {
                    event.target.value = normalizeDate(event.target.value);
                }
                return false;
            }
            return true;
        }

        // G√©rer la soumission du formulaire
        function handleFormSubmit(event) {
            event.preventDefault();
            submitForm();
            return false;
        }

        // Fonction pour convertir jj/mm/aa en date ISO (yyyy-mm-dd)
        function convertToISO(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            
            const jour = parts[0].padStart(2, '0');
            const mois = parts[1].padStart(2, '0');
            let annee = parts[2];
            
            // Si ann√©e sur 2 chiffres, ajouter 20 devant
            if (annee.length === 2) {
                annee = '20' + annee;
            }
            
            return `${annee}-${mois}-${jour}`;
        }

        // Fonction pour convertir date ISO en jj/mm/aa
        function convertFromISO(dateISO) {
            if (!dateISO) return '';
            const parts = dateISO.split('-');
            if (parts.length !== 3) return dateISO;
            
            const annee = parts[0].substring(2); // Prendre les 2 derniers chiffres
            const mois = parts[1];
            const jour = parts[2];
            
            return `${jour}/${mois}/${annee}`;
        }

        // Gestion du changement dans le menu d√©roulant
        function handleQuiChange() {
            const select = document.getElementById('qui');
            const customGroup = document.getElementById('customQuiGroup');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
                document.getElementById('customQui').focus();
            } else {
                customGroup.style.display = 'none';
            }
        }

        // Mettre √† jour le menu d√©roulant avec les destinataires sauvegard√©s
        function updateQuiSelect() {
            const select = document.getElementById('qui');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- S√©lectionner ou ajouter --</option>';
            
            destinataires.forEach(dest => {
                const option = document.createElement('option');
                option.value = dest;
                option.textContent = dest;
                select.appendChild(option);
            });
            
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = '‚ûï Nouveau destinataire';
            select.appendChild(customOption);
            
            if (currentValue && destinataires.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        // Gestion du formulaire
        function submitForm() {
            console.log('submitForm appel√©e - editingId:', editingId);
            
            let quiValue = document.getElementById('qui').value;
            
            // Si l'utilisateur a choisi d'ajouter un nouveau destinataire
            if (quiValue === 'custom') {
                const customQui = document.getElementById('customQui').value.trim();
                if (!customQui) {
                    alert('Veuillez entrer un nom de destinataire');
                    return;
                }
                quiValue = customQui;
                
                // Ajouter le nouveau destinataire √† la liste s'il n'existe pas
                if (!destinataires.includes(quiValue)) {
                    destinataires.push(quiValue);
                    localStorage.setItem('destinataires', JSON.stringify(destinataires));
                    updateQuiSelect();
                }
            }
            
            // V√©rifier que quiValue n'est pas vide
            if (!quiValue) {
                alert('Veuillez s√©lectionner un destinataire');
                return;
            }
            
            // Convertir les dates au format ISO pour le stockage
            const dateDemande = convertToISO(normalizeDate(document.getElementById('dateDemande').value));
            const dateDemandee = convertToISO(normalizeDate(document.getElementById('dateDemandee').value));
            const dateValidee = convertToISO(normalizeDate(document.getElementById('dateValidee').value));
            
            const nouvelleDemande = {
                id: editingId || Date.now(),
                projet: document.getElementById('projet').value,
                dateDemande: dateDemande,
                qui: quiValue,
                dateDemandee: dateDemandee,
                dateValidee: dateValidee,
                livraison: document.getElementById('livraison').checked,
                notes: document.getElementById('notes').value
            };

            console.log('Demande cr√©√©e:', nouvelleDemande);

            // Si c'est une modification
            if (editingId) {
                console.log('Mode MODIFICATION');
                const index = demandes.findIndex(d => d.id === editingId);
                const ancienneDemande = demandes[index];
                
                // V√©rifier si des donn√©es importantes ont chang√©
                const donneesOntChange = (
                    ancienneDemande.projet !== nouvelleDemande.projet ||
                    ancienneDemande.dateDemande !== nouvelleDemande.dateDemande ||
                    ancienneDemande.qui !== nouvelleDemande.qui ||
                    ancienneDemande.dateDemandee !== nouvelleDemande.dateDemandee ||
                    ancienneDemande.dateValidee !== nouvelleDemande.dateValidee ||
                    ancienneDemande.livraison !== nouvelleDemande.livraison
                );
                
                console.log('Donn√©es ont chang√©:', donneesOntChange);
                
                // Mettre √† jour la demande
                demandes[index] = nouvelleDemande;
                
                // Si des donn√©es importantes ont chang√©, v√©rifier si une alerte est n√©cessaire
                if (donneesOntChange) {
                    const alerte = checkAlerteForDemande(nouvelleDemande);
                    
                    if (alerte) {
                        // Envoyer imm√©diatement la notification (sans limite pour les modifications)
                        showAlert(alerte.titre, alerte.message, alerte.projet, alerte.qui);
                    }
                }
                
                editingId = null;
            } else {
                console.log('Mode AJOUT');
                // Nouvelle demande - pas de notification
                demandes.push(nouvelleDemande);
                console.log('Demande ajout√©e. Total demandes:', demandes.length);
            }

            saveDemandes();
            resetForm();
            renderDemandes();
        }

        // R√©initialiser les notifications pour une demande modifi√©e
        function resetNotificationPourModification(demandeId) {
            const stored = localStorage.getItem('notificationsEnvoyees');
            if (!stored) return;
            
            const data = JSON.parse(stored);
            const today = new Date().toDateString();
            
            // Si c'est bien aujourd'hui, supprimer les notifications de cette demande
            if (data.date === today && data.notifications && data.notifications[demandeId]) {
                delete data.notifications[demandeId];
                localStorage.setItem('notificationsEnvoyees', JSON.stringify(data));
            }
        }

        // R√©initialiser le formulaire
        function resetForm() {
            document.getElementById('demandeForm').reset();
            document.getElementById('customQuiGroup').style.display = 'none';
            document.getElementById('submitBtn').textContent = '‚ûï Ajouter la demande';
            document.getElementById('cancelBtn').style.display = 'none';
            editingId = null;
        }

        // Annuler la modification
        function cancelEdit() {
            resetForm();
        }

        // Sauvegarde dans localStorage
        function saveDemandes() {
            localStorage.setItem('demandes', JSON.stringify(demandes));
        }

        // Calcul du voyant (sans d√©clencher les alertes)
        function calculerVoyant(demande) {
            const aujourdHui = new Date();
            aujourdHui.setHours(0, 0, 0, 0);

            // Si livraison coch√©e, voyant vert
            if (demande.livraison) {
                return 'vert';
            }

            // Si pas de date valid√©e
            if (!demande.dateValidee) {
                return 'gris';
            }

            // Si date valid√©e existe
            const dateValidee = new Date(demande.dateValidee);
            dateValidee.setHours(0, 0, 0, 0);

            // Si aujourd'hui > date valid√©e : rouge
            if (aujourdHui > dateValidee) {
                return 'rouge';
            }

            return 'gris';
        }

        // V√©rifier si une demande n√©cessite une alerte
        function checkAlerteForDemande(demande) {
            const aujourdHui = new Date();
            aujourdHui.setHours(0, 0, 0, 0);

            // Si livraison coch√©e, pas d'alerte
            if (demande.livraison) {
                return null;
            }

            // Si pas de date valid√©e
            if (!demande.dateValidee) {
                const dateDemande = new Date(demande.dateDemande);
                const diffJours = Math.floor((aujourdHui - dateDemande) / (1000 * 60 * 60 * 24));
                
                // Attendre 3 jours apr√®s la date de demande
                if (diffJours >= 3) {
                    return {
                        type: '3jours',
                        titre: '‚è∞ Attention',
                        message: `Date du proto ${demande.projet} de ${demande.qui} non planifi√©!`,
                        projet: demande.projet,
                        qui: demande.qui,
                        demandeId: demande.id
                    };
                }
                return null;
            }

            // Si date valid√©e existe
            const dateValidee = new Date(demande.dateValidee);
            dateValidee.setHours(0, 0, 0, 0);
            const diffJours = Math.floor((dateValidee - aujourdHui) / (1000 * 60 * 60 * 24));

            // Si aujourd'hui > date valid√©e : rouge avec alerte
            if (aujourdHui > dateValidee) {
                return {
                    type: 'depassement',
                    titre: 'üö® Alerte Urgente',
                    message: `${demande.qui} - ${demande.projet} a d√©pass√© sa date de livraison valid√©e !`,
                    projet: demande.projet,
                    qui: demande.qui,
                    demandeId: demande.id
                };
            }

            // Si 7 jours ou moins avant la date valid√©e : gris avec alerte
            if (diffJours <= 7 && diffJours >= 0) {
                return {
                    type: '7jours',
                    titre: 'üìû Confirmation de livraison',
                    message: `Appeler ${demande.qui} pour confirmer le d√©lai de livraison du projet ${demande.projet}.`,
                    projet: demande.projet,
                    qui: demande.qui,
                    demandeId: demande.id
                };
            }

            return null;
        }

        // Afficher une notification syst√®me Windows
        async function showSystemNotification(title, message) {
            if ('Notification' in window) {
                // V√©rifier et demander la permission si n√©cessaire
                if (Notification.permission === 'default') {
                    const granted = await demanderPermissionNotifications();
                    if (!granted) return;
                }
                
                if (Notification.permission === 'granted') {
                    try {
                        // Utiliser une notification simple sans ic√¥ne SVG complexe
                        const notification = new Notification(title, {
                            body: message,
                            // PAS d'ic√¥ne pour √©viter les erreurs avec file:///
                            requireInteraction: true,
                            silent: false,
                            tag: 'demande-' + Date.now(),
                            renotify: true,
                            vibrate: [200, 100, 200],
                            timestamp: Date.now()
                        });
                        
                        // Focus sur la fen√™tre quand on clique
                        notification.onclick = function() {
                            window.focus();
                            this.close();
                        };
                        
                        // Jouer un son
                        try {
                            const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8PVank5ZxiGgo+ltPxzH8pBCl+zPLaizsIGGS67OihUxELTKXh8bllHAU2jdXzzn0sBCd8yfHajjwJFmm98+mjVBQNUqjl6KRVFApCm9zyt2gbBDKJ0/PMezAHIHO/8d6WRQsRXbTq66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8PVank5ZxiGgo+ltPxzH8pBCl+zPLaizsIGGS67OihUxELTKXh8bllHAU2jdXzzn0sBCd8yfHajjwJFmm98+mjVBQNUqjl6KRVFApCm9zyt2gbBDKJ0/PMezAHIHO/8d6WRQsRXbTq66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8PVank5ZxiGgo+ltPxzH8pBCl+zPLaizsIGGS67OihUxELTKXh8bllHAU2jdXzzn0sBCd8yfHajjwJFmm98+mjVBQNUqjl6KRVFApCm9zyt2gbBDKJ0/PMezAHIHO/8d6WRQsRXbTq66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8PVank5ZxiGgo+ltPxzH8pBCl+zPLaizsIGGS67OihUxELTKXh8bllHAU2jdXzzn0sBCd8yfHajjwJFmm98+mjVBQNUqjl6KRVFApCm9zyt2gbBDKJ0/PMezAHIHO/8d6WRQsRXbTq66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZUQ8PVank5ZxiGgo+ltPxzH8pBCl+zPLaizsIGGS67OihUxELTKXh8bllHAU2jdXzzn0sBCd8yfHajjwJFmm98+mjVBQNUqjl6KRVFApCm9zyt2gbBDKJ0/PMezAHIHO/8d6WRQsRXbTq66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZ');
                            beep.volume = 0.3;
                            beep.play().catch(() => {});
                        } catch (e) {}
                        
                        console.log('‚úÖ Notification Windows envoy√©e:', title);
                        
                    } catch (error) {
                        console.error('‚ùå Erreur notification:', error);
                        console.error('D√©tails:', error.message);
                    }
                } else if (Notification.permission === 'denied') {
                    console.warn('‚ö†Ô∏è Notifications bloqu√©es');
                }
            }
        }

        // Afficher une alerte
        function showAlert(title, message, projet, qui) {
            // Remplacer les noms de projet et qui par des versions en gras dans le HTML
            let formattedMessage = message;
            if (projet) {
                formattedMessage = formattedMessage.replace(projet, `<strong>${projet}</strong>`);
            }
            if (qui) {
                formattedMessage = formattedMessage.replace(qui, `<strong>${qui}</strong>`);
            }
            
            document.getElementById('modalHeader').textContent = title;
            document.getElementById('modalBody').innerHTML = formattedMessage;
            document.getElementById('alertModal').style.display = 'block';
            
            // Notification syst√®me (sans HTML)
            showSystemNotification(title, message);
        }

        // Fermer la modal
        function closeModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        // Fermer la modal en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            const modal = document.getElementById('alertModal');
            if (event.target === modal) {
                closeModal();
            }
        }

        // Fonction pour cat√©goriser une demande pour le tri
        function getCategorie(demande, aujourdHui) {
            // 4. Livr√©e
            if (demande.livraison) return 4;
            
            // Si pas de date valid√©e
            if (!demande.dateValidee) return 2; // Sans date
            
            // Si date valid√©e existe
            const dateValidee = new Date(demande.dateValidee);
            dateValidee.setHours(0, 0, 0, 0);
            
            // 1. D√©pass√©e
            if (dateValidee < aujourdHui) return 1;
            
            // 3. Avec date (pas encore d√©pass√©e)
            return 3;
        }

        // Afficher les demandes
        function renderDemandes() {
            const container = document.getElementById('demandesList');
            
            if (demandes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Aucune demande</h3>
                        <p>Ajoutez votre premi√®re demande pour commencer</p>
                    </div>
                `;
                return;
            }

            // Trier les demandes selon la priorit√©
            const demandesSorted = [...demandes].sort((a, b) => {
                const aujourdHui = new Date();
                aujourdHui.setHours(0, 0, 0, 0);
                
                // Cat√©goriser les demandes
                const categorieA = getCategorie(a, aujourdHui);
                const categorieB = getCategorie(b, aujourdHui);
                
                // Ordre des cat√©gories: depassee (1) < sansDate (2) < avecDate (3) < livree (4)
                if (categorieA !== categorieB) {
                    return categorieA - categorieB;
                }
                
                // Dans la m√™me cat√©gorie, trier par date
                if (categorieA === 1 || categorieA === 3) {
                    // D√©pass√©es et avec date: ordre chronologique de date valid√©e
                    return new Date(a.dateValidee) - new Date(b.dateValidee);
                } else if (categorieA === 2) {
                    // Sans date: ordre de date de demande
                    return new Date(a.dateDemande) - new Date(b.dateDemande);
                } else {
                    // Livr√©es: ordre de date valid√©e (ou demande si pas de valid√©e)
                    const dateA = a.dateValidee ? new Date(a.dateValidee) : new Date(a.dateDemande);
                    const dateB = b.dateValidee ? new Date(b.dateValidee) : new Date(b.dateDemande);
                    return dateA - dateB;
                }
            });

            container.innerHTML = demandesSorted.map(demande => {
                const voyant = calculerVoyant(demande);
                const dateValideeText = demande.dateValidee ? formatDate(demande.dateValidee) : 'Non d√©finie';
                const notesHtml = demande.notes ? `
                    <div class="demande-notes">
                        <div class="demande-notes-label">üìù Notes :</div>
                        <div>${demande.notes}</div>
                    </div>
                ` : '';
                
                // Ajouter le gyrophare si voyant rouge
                const gyrophareHtml = voyant === 'rouge' ? '<span class="gyrophare">üö®</span>' : '';
                
                return `
                    <div class="demande-card">
                        <div class="demande-header">
                            <div class="demande-projet">${demande.projet}</div>
                            <div style="display: flex; align-items: center;">
                                <div class="voyant ${voyant}"></div>
                                ${gyrophareHtml}
                            </div>
                        </div>
                        <div class="demande-info">
                            <div class="info-item">
                                <div class="info-label">Date demande:</div>
                                <div class="info-value">${formatDate(demande.dateDemande)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Responsable:</div>
                                <div class="info-value">${demande.qui}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Livraison:</div>
                                <div class="info-value">${demande.livraison ? '‚úÖ Effectu√©e' : '‚è≥ En attente'}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date demand√©e:</div>
                                <div class="info-value">${formatDate(demande.dateDemandee)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date valid√©e:</div>
                                <div class="info-value">${dateValideeText}</div>
                            </div>
                        </div>
                        ${notesHtml}
                        <div class="demande-actions">
                            <button class="btn-small btn-edit" onclick="editDemande(${demande.id})">‚úèÔ∏è Modifier</button>
                            <button class="btn-small btn-delete" onclick="deleteDemande(${demande.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Formater une date
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const jour = String(date.getDate()).padStart(2, '0');
            const mois = String(date.getMonth() + 1).padStart(2, '0');
            const annee = String(date.getFullYear()).substring(2); // 2 derniers chiffres
            return `${jour}/${mois}/${annee}`;
        }

        // Modifier une demande
        function editDemande(id) {
            const demande = demandes.find(d => d.id === id);
            if (demande) {
                document.getElementById('projet').value = demande.projet;
                document.getElementById('dateDemande').value = convertFromISO(demande.dateDemande);
                document.getElementById('dateDemandee').value = convertFromISO(demande.dateDemandee);
                document.getElementById('dateValidee').value = convertFromISO(demande.dateValidee);
                document.getElementById('livraison').checked = demande.livraison;
                document.getElementById('notes').value = demande.notes || '';
                
                // G√©rer le menu d√©roulant
                const quiSelect = document.getElementById('qui');
                if (destinataires.includes(demande.qui)) {
                    quiSelect.value = demande.qui;
                } else {
                    // Si le destinataire n'est plus dans la liste, l'ajouter
                    if (!destinataires.includes(demande.qui)) {
                        destinataires.push(demande.qui);
                        localStorage.setItem('destinataires', JSON.stringify(destinataires));
                        updateQuiSelect();
                    }
                    quiSelect.value = demande.qui;
                }
                
                document.getElementById('customQuiGroup').style.display = 'none';
                document.getElementById('submitBtn').textContent = '‚úèÔ∏è Modifier la demande';
                document.getElementById('cancelBtn').style.display = 'block';
                editingId = id;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // Supprimer une demande
        function deleteDemande(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette demande ?')) {
                demandes = demandes.filter(d => d.id !== id);
                saveDemandes();
                renderDemandes();
            }
        }

        // Initialisation
        renderDemandes();
    </script>
</body>
</html>