<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Demandes</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .btn-print {
            position: absolute;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            padding: 12px 24px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-print:hover {
            background: #f0f0f0;
            transform: translateY(-50%) scale(1.05);
        }

        .main-content {
            display: grid;
            grid-template-columns: 400px 1fr;
            gap: 0;
            min-height: 600px;
        }

        .form-section {
            background: #f8f9fa;
            padding: 30px;
            border-right: 2px solid #e0e0e0;
        }

        .form-section h2 {
            color: #667eea;
            margin-bottom: 25px;
            font-size: 1.5em;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 0.95em;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:active {
            transform: translateY(0);
        }

        .list-section {
            padding: 30px;
            overflow-y: auto;
            max-height: 800px;
        }

        .list-section h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .demande-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s;
            position: relative;
        }

        .demande-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .demande-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .demande-projet {
            font-size: 1.3em;
            font-weight: 700;
            color: #333;
        }

        .voyant {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .voyant.vert {
            background: #4CAF50;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.6);
        }

        .voyant.gris {
            background: #9E9E9E;
        }

        .voyant.rouge {
            background: #f44336;
            box-shadow: 0 0 20px rgba(244, 67, 54, 0.6);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .gyrophare {
            font-size: 1.5em;
            margin-left: 10px;
            animation: rotate 1s linear infinite;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .demande-info {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }

        .info-item {
            font-size: 0.9em;
        }

        .info-label {
            color: #666;
            font-weight: 600;
        }

        .info-value {
            color: #333;
            margin-top: 3px;
        }

        .info-value.bold {
            font-weight: 700;
        }

        .demande-notes {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 6px;
            margin: 15px 0;
            font-size: 0.9em;
            color: #555;
            border-left: 4px solid #667eea;
        }

        .demande-notes-label {
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .demande-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-small {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-delete {
            background: #f44336;
            color: white;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .btn-edit {
            background: #2196F3;
            color: white;
        }

        .btn-edit:hover {
            background: #1976D2;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            font-size: 1.5em;
            color: #333;
            margin-bottom: 15px;
            font-weight: 700;
        }

        .modal-body {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
        }

        .modal-footer {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1em;
            transition: all 0.2s;
        }

        .modal-btn-primary {
            background: #667eea;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #5568d3;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 4em;
            margin-bottom: 20px;
        }

        @media print {
            body {
                background: white;
                padding: 0;
            }
            .container {
                box-shadow: none;
            }
            .header .btn-print,
            .form-section,
            .demande-actions,
            .main-content {
                display: none;
            }
            .list-section {
                max-height: none;
                overflow: visible;
            }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .form-section {
                border-right: none;
                border-bottom: 2px solid #e0e0e0;
            }
            .btn-print {
                position: static;
                transform: none;
                margin-top: 15px;
                display: block;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã Gestion des Demandes</h1>
            <p>Syst√®me de suivi et d'alertes automatiques</p>
            <button class="btn-print" onclick="imprimerListe()">üñ®Ô∏è Imprimer la liste</button>
        </div>

        <div class="main-content">
            <div class="form-section">
                <h2>Nouvelle Demande</h2>
                <form id="demandeForm" onsubmit="return handleFormSubmit(event)">
                    <div class="form-group">
                        <label for="projet">Projet</label>
                        <input type="text" id="projet" required placeholder="Nom du projet" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="dateDemande">Date de la demande</label>
                        <input type="text" id="dateDemande" required placeholder="jj/mm/26" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="qui">QUI (Destinataire)</label>
                        <select id="qui" required onchange="handleQuiChange()">
                            <option value="">-- S√©lectionner ou ajouter --</option>
                            <option value="custom">‚ûï Nouveau destinataire</option>
                        </select>
                    </div>

                    <div class="form-group" id="customQuiGroup" style="display: none;">
                        <label for="customQui">Nom du nouveau destinataire</label>
                        <input type="text" id="customQui" placeholder="Entrez le nom puis validez le formulaire" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="dateDemandee">Date demand√©e</label>
                        <input type="text" id="dateDemandee" required placeholder="jj/mm/26" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <label for="dateValidee">Date valid√©e</label>
                        <input type="text" id="dateValidee" placeholder="jj/mm/26" onkeypress="return preventEnterSubmit(event)">
                    </div>

                    <div class="form-group">
                        <div class="checkbox-group">
                            <input type="checkbox" id="livraison">
                            <label for="livraison">Livraison effectu√©e</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="notes">Notes</label>
                        <textarea id="notes" rows="3" placeholder="Ajoutez des notes ou commentaires..." style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; font-size: 1em; resize: vertical;"></textarea>
                    </div>

                    <button type="submit" class="btn" id="submitBtn">‚ûï Ajouter la demande</button>
                    <button type="button" class="btn" id="cancelBtn" style="display: none; background: #9E9E9E; margin-top: 10px;" onclick="cancelEdit()">‚úñÔ∏è Annuler</button>
                </form>
            </div>

            <div class="list-section">
                <h2>Liste des Demandes</h2>
                <div id="demandesList"></div>
            </div>
        </div>
    </div>

    <!-- Modal pour les alertes -->
    <div id="alertModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader"></div>
            <div class="modal-body" id="modalBody"></div>
            <div class="modal-footer">
                <button class="modal-btn modal-btn-primary" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== DONN√âES ====================
        let demandes = JSON.parse(localStorage.getItem('demandes')) || [];
        let destinataires = JSON.parse(localStorage.getItem('destinataires')) || [];
        let editingId = null;

        // ==================== INITIALISATION ====================
        updateQuiSelect();
        demanderPermissionNotifications();

        // ==================== PERMISSIONS NOTIFICATIONS ====================
        async function demanderPermissionNotifications() {
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(async () => {
                    if (confirm('üîî Cette application envoie des notifications Windows pour vos alertes.\n\nVoulez-vous activer les notifications ?')) {
                        const permission = await Notification.requestPermission();
                        if (permission === 'granted') {
                            new Notification('‚úÖ Notifications activ√©es', {
                                body: 'Vous recevrez des alertes pour vos demandes.',
                                requireInteraction: false
                            });
                        }
                    }
                }, 1000);
            }
        }

        // ==================== GESTION DES DATES ====================
        function getCurrentYear() {
            return new Date().getFullYear().toString().substring(2);
        }

        function normalizeDate(input) {
            if (!input) return '';
            let parts = input.split('/');
            if (parts.length === 0) return '';
            
            let jour = parts[0] ? parts[0].trim() : '';
            if (jour && jour.length === 1) jour = '0' + jour;
            
            let mois = parts[1] ? parts[1].trim() : '';
            if (mois && mois.length === 1) mois = '0' + mois;
            
            let annee = parts[2] ? parts[2].trim() : getCurrentYear();
            if (annee.length === 1) annee = '0' + annee;
            
            if (jour && mois) {
                return `${jour}/${mois}/${annee}`;
            }
            return input;
        }

        ['dateDemande', 'dateDemandee', 'dateValidee'].forEach(fieldId => {
            document.getElementById(fieldId).addEventListener('blur', function() {
                this.value = normalizeDate(this.value);
            });
        });

        function convertToISO(dateStr) {
            if (!dateStr) return '';
            const parts = dateStr.split('/');
            if (parts.length !== 3) return dateStr;
            
            const jour = parts[0].padStart(2, '0');
            const mois = parts[1].padStart(2, '0');
            let annee = parts[2];
            if (annee.length === 2) annee = '20' + annee;
            
            return `${annee}-${mois}-${jour}`;
        }

        function convertFromISO(dateISO) {
            if (!dateISO) return '';
            const parts = dateISO.split('-');
            if (parts.length !== 3) return dateISO;
            
            const annee = parts[0].substring(2);
            const mois = parts[1];
            const jour = parts[2];
            
            return `${jour}/${mois}/${annee}`;
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            const jour = String(date.getDate()).padStart(2, '0');
            const mois = String(date.getMonth() + 1).padStart(2, '0');
            const annee = String(date.getFullYear()).substring(2);
            return `${jour}/${mois}/${annee}`;
        }

        // ==================== GESTION FORMULAIRE ====================
        function preventEnterSubmit(event) {
            if (event.keyCode === 13 || event.which === 13) {
                event.preventDefault();
                if (event.target.type === 'text') {
                    event.target.value = normalizeDate(event.target.value);
                }
                return false;
            }
            return true;
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            submitForm();
            return false;
        }

        function handleQuiChange() {
            const select = document.getElementById('qui');
            const customGroup = document.getElementById('customQuiGroup');
            
            if (select.value === 'custom') {
                customGroup.style.display = 'block';
                document.getElementById('customQui').focus();
            } else {
                customGroup.style.display = 'none';
            }
        }

        function updateQuiSelect() {
            const select = document.getElementById('qui');
            const currentValue = select.value;
            
            select.innerHTML = '<option value="">-- S√©lectionner ou ajouter --</option>';
            
            destinataires.forEach(dest => {
                const option = document.createElement('option');
                option.value = dest;
                option.textContent = dest;
                select.appendChild(option);
            });
            
            const customOption = document.createElement('option');
            customOption.value = 'custom';
            customOption.textContent = '‚ûï Nouveau destinataire';
            select.appendChild(customOption);
            
            if (currentValue && destinataires.includes(currentValue)) {
                select.value = currentValue;
            }
        }

        function submitForm() {
            let quiValue = document.getElementById('qui').value;
            
            if (quiValue === 'custom') {
                const customQui = document.getElementById('customQui').value.trim();
                if (!customQui) {
                    alert('Veuillez entrer un nom de destinataire');
                    return;
                }
                quiValue = customQui;
                
                if (!destinataires.includes(quiValue)) {
                    destinataires.push(quiValue);
                    localStorage.setItem('destinataires', JSON.stringify(destinataires));
                    updateQuiSelect();
                }
            }
            
            if (!quiValue) {
                alert('Veuillez s√©lectionner un destinataire');
                return;
            }
            
            const dateDemande = convertToISO(normalizeDate(document.getElementById('dateDemande').value));
            const dateDemandee = convertToISO(normalizeDate(document.getElementById('dateDemandee').value));
            const dateValidee = convertToISO(normalizeDate(document.getElementById('dateValidee').value));
            
            const nouvelleDemande = {
                id: editingId || Date.now(),
                projet: document.getElementById('projet').value,
                dateDemande: dateDemande,
                qui: quiValue,
                dateDemandee: dateDemandee,
                dateValidee: dateValidee,
                livraison: document.getElementById('livraison').checked,
                notes: document.getElementById('notes').value
            };

            if (editingId) {
                const index = demandes.findIndex(d => d.id === editingId);
                const ancienneDemande = demandes[index];
                
                const donneesOntChange = (
                    ancienneDemande.projet !== nouvelleDemande.projet ||
                    ancienneDemande.dateDemande !== nouvelleDemande.dateDemande ||
                    ancienneDemande.qui !== nouvelleDemande.qui ||
                    ancienneDemande.dateDemandee !== nouvelleDemande.dateDemandee ||
                    ancienneDemande.dateValidee !== nouvelleDemande.dateValidee ||
                    ancienneDemande.livraison !== nouvelleDemande.livraison
                );
                
                demandes[index] = nouvelleDemande;
                
                if (donneesOntChange) {
                    const alerte = checkAlerteForDemande(nouvelleDemande);
                    if (alerte) {
                        showAlert(alerte.titre, alerte.message, alerte.projet, alerte.qui);
                    }
                }
                
                editingId = null;
            } else {
                demandes.push(nouvelleDemande);
            }

            saveDemandes();
            resetForm();
            renderDemandes();
        }

        function resetForm() {
            document.getElementById('demandeForm').reset();
            document.getElementById('customQuiGroup').style.display = 'none';
            document.getElementById('submitBtn').textContent = '‚ûï Ajouter la demande';
            document.getElementById('cancelBtn').style.display = 'none';
            editingId = null;
        }

        function cancelEdit() {
            resetForm();
        }

        function saveDemandes() {
            localStorage.setItem('demandes', JSON.stringify(demandes));
        }

        // ==================== CALCUL VOYANT ET ALERTES ====================
        function calculerVoyant(demande) {
            const aujourdHui = new Date();
            aujourdHui.setHours(0, 0, 0, 0);

            if (demande.livraison) return 'vert';
            if (!demande.dateValidee) return 'gris';

            const dateValidee = new Date(demande.dateValidee);
            dateValidee.setHours(0, 0, 0, 0);

            if (aujourdHui > dateValidee) return 'rouge';
            return 'gris';
        }

        function checkAlerteForDemande(demande) {
            const aujourdHui = new Date();
            aujourdHui.setHours(0, 0, 0, 0);

            if (demande.livraison) return null;

            if (!demande.dateValidee) {
                const dateDemande = new Date(demande.dateDemande);
                const diffJours = Math.floor((aujourdHui - dateDemande) / (1000 * 60 * 60 * 24));
                
                if (diffJours >= 3) {
                    return {
                        type: '3jours',
                        titre: '‚è∞ Attention',
                        message: `Date du proto ${demande.projet} de ${demande.qui} non planifi√©!`,
                        projet: demande.projet,
                        qui: demande.qui,
                        demandeId: demande.id
                    };
                }
                return null;
            }

            const dateValidee = new Date(demande.dateValidee);
            dateValidee.setHours(0, 0, 0, 0);
            const diffJours = Math.floor((dateValidee - aujourdHui) / (1000 * 60 * 60 * 24));

            if (aujourdHui > dateValidee) {
                return {
                    type: 'depassement',
                    titre: 'üö® Alerte Urgente',
                    message: `${demande.qui} - ${demande.projet} a d√©pass√© sa date de livraison valid√©e !`,
                    projet: demande.projet,
                    qui: demande.qui,
                    demandeId: demande.id
                };
            }

            if (diffJours <= 7 && diffJours >= 0) {
                return {
                    type: '7jours',
                    titre: 'üìû Confirmation de livraison',
                    message: `Appeler ${demande.qui} pour confirmer le d√©lai de livraison du projet ${demande.projet}.`,
                    projet: demande.projet,
                    qui: demande.qui,
                    demandeId: demande.id
                };
            }

            return null;
        }

        // ==================== NOTIFICATIONS ====================
        async function showSystemNotification(title, message) {
            if ('Notification' in window && Notification.permission === 'granted') {
                try {
                    const notification = new Notification(title, {
                        body: message,
                        requireInteraction: true,
                        silent: false,
                        tag: 'demande-' + Date.now()
                    });
                    
                    notification.onclick = function() {
                        window.focus();
                        this.close();
                    };
                } catch (error) {
                    console.error('Erreur notification:', error);
                }
            }
        }

        function showAlert(title, message, projet, qui) {
            let formattedMessage = message;
            if (projet) formattedMessage = formattedMessage.replace(projet, `<strong>${projet}</strong>`);
            if (qui) formattedMessage = formattedMessage.replace(qui, `<strong>${qui}</strong>`);
            
            document.getElementById('modalHeader').textContent = title;
            document.getElementById('modalBody').innerHTML = formattedMessage;
            document.getElementById('alertModal').style.display = 'block';
            
            showSystemNotification(title, message);
        }

        function closeModal() {
            document.getElementById('alertModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('alertModal');
            if (event.target === modal) closeModal();
        }

        // ==================== SYST√àME DE V√âRIFICATION QUOTIDIENNE ====================
        function getNotificationsEnvoyees() {
            const stored = localStorage.getItem('notificationsEnvoyees');
            if (!stored) return {};
            
            const data = JSON.parse(stored);
            const today = new Date().toDateString();
            
            if (data.date !== today) return {};
            return data.notifications || {};
        }

        function saveNotificationEnvoyee(demandeId, type) {
            const today = new Date().toDateString();
            const notifications = getNotificationsEnvoyees();
            
            if (!notifications[demandeId]) notifications[demandeId] = [];
            if (!notifications[demandeId].includes(type)) {
                notifications[demandeId].push(type);
            }
            
            localStorage.setItem('notificationsEnvoyees', JSON.stringify({
                date: today,
                notifications: notifications
            }));
        }

        function dejaEnvoyee(demandeId, type) {
            const notifications = getNotificationsEnvoyees();
            return notifications[demandeId] && notifications[demandeId].includes(type);
        }

        function verifierEtEnvoyerAlertes() {
            demandes.forEach(demande => {
                const alerte = checkAlerteForDemande(demande);
                if (alerte && !dejaEnvoyee(alerte.demandeId, alerte.type)) {
                    showAlert(alerte.titre, alerte.message, alerte.projet, alerte.qui);
                    saveNotificationEnvoyee(alerte.demandeId, alerte.type);
                }
            });
        }

        function getMillisecondsUntil9AM() {
            const now = new Date();
            const next9AM = new Date();
            next9AM.setHours(9, 0, 0, 0);
            
            if (now >= next9AM) {
                next9AM.setDate(next9AM.getDate() + 1);
            }
            
            return next9AM - now;
        }

        function programmerVerificationQuotidienne() {
            const delai = getMillisecondsUntil9AM();
            
            setTimeout(() => {
                verifierEtEnvoyerAlertes();
                setInterval(() => {
                    verifierEtEnvoyerAlertes();
                }, 24 * 60 * 60 * 1000);
            }, delai);
        }

        function verificationInitiale() {
            const lastCheck = localStorage.getItem('lastAlertCheck');
            const today = new Date().toDateString();
            
            if (lastCheck !== today) {
                verifierEtEnvoyerAlertes();
                localStorage.setItem('lastAlertCheck', today);
            }
        }

        verificationInitiale();
        programmerVerificationQuotidienne();

        // ==================== TRI ET AFFICHAGE ====================
        function getCategorie(demande, aujourdHui) {
            if (demande.livraison) return 4;
            if (!demande.dateValidee) return 2;
            
            const dateValidee = new Date(demande.dateValidee);
            dateValidee.setHours(0, 0, 0, 0);
            
            if (dateValidee < aujourdHui) return 1;
            return 3;
        }

        function renderDemandes() {
            const container = document.getElementById('demandesList');
            
            if (demandes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì≠</div>
                        <h3>Aucune demande</h3>
                        <p>Ajoutez votre premi√®re demande pour commencer</p>
                    </div>
                `;
                return;
            }

            const aujourdHui = new Date();
            aujourdHui.setHours(0, 0, 0, 0);

            const demandesSorted = [...demandes].sort((a, b) => {
                const categorieA = getCategorie(a, aujourdHui);
                const categorieB = getCategorie(b, aujourdHui);
                
                if (categorieA !== categorieB) return categorieA - categorieB;
                
                if (categorieA === 1 || categorieA === 3) {
                    return new Date(a.dateValidee) - new Date(b.dateValidee);
                } else if (categorieA === 2) {
                    return new Date(a.dateDemande) - new Date(b.dateDemande);
                } else {
                    const dateA = a.dateValidee ? new Date(a.dateValidee) : new Date(a.dateDemande);
                    const dateB = b.dateValidee ? new Date(b.dateValidee) : new Date(b.dateDemande);
                    return dateA - dateB;
                }
            });

            container.innerHTML = demandesSorted.map(demande => {
                const voyant = calculerVoyant(demande);
                const dateValideeText = demande.dateValidee ? formatDate(demande.dateValidee) : 'Non d√©finie';
                const livraisonText = demande.livraison ? '‚úÖ Effectu√©e' : '‚è≥ En attente';
                const notesHtml = demande.notes ? `
                    <div class="demande-notes">
                        <div class="demande-notes-label">üìù Notes :</div>
                        <div>${demande.notes}</div>
                    </div>
                ` : '';
                const gyrophareHtml = voyant === 'rouge' ? '<span class="gyrophare">üö®</span>' : '';
                
                return `
                    <div class="demande-card">
                        <div class="demande-header">
                            <div class="demande-projet">${demande.projet}</div>
                            <div style="display: flex; align-items: center;">
                                <div class="voyant ${voyant}"></div>
                                ${gyrophareHtml}
                            </div>
                        </div>
                        <div class="demande-info">
                            <div class="info-item">
                                <div class="info-label">Date demande:</div>
                                <div class="info-value">${formatDate(demande.dateDemande)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Responsable:</div>
                                <div class="info-value">${demande.qui}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Livraison:</div>
                                <div class="info-value bold">${livraisonText}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date demand√©e:</div>
                                <div class="info-value">${formatDate(demande.dateDemandee)}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">Date valid√©e:</div>
                                <div class="info-value bold">${dateValideeText}</div>
                            </div>
                        </div>
                        ${notesHtml}
                        <div class="demande-actions">
                            <button class="btn-small btn-edit" onclick="editDemande(${demande.id})">‚úèÔ∏è Modifier</button>
                            <button class="btn-small btn-delete" onclick="deleteDemande(${demande.id})">üóëÔ∏è Supprimer</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editDemande(id) {
            const demande = demandes.find(d => d.id === id);
            if (demande) {
                document.getElementById('projet').value = demande.projet;
                document.getElementById('dateDemande').value = convertFromISO(demande.dateDemande);
                document.getElementById('dateDemandee').value = convertFromISO(demande.dateDemandee);
                document.getElementById('dateValidee').value = convertFromISO(demande.dateValidee);
                document.getElementById('livraison').checked = demande.livraison;
                document.getElementById('notes').value = demande.notes || '';
                
                const quiSelect = document.getElementById('qui');
                if (destinataires.includes(demande.qui)) {
                    quiSelect.value = demande.qui;
                } else {
                    if (!destinataires.includes(demande.qui)) {
                        destinataires.push(demande.qui);
                        localStorage.setItem('destinataires', JSON.stringify(destinataires));
                        updateQuiSelect();
                    }
                    quiSelect.value = demande.qui;
                }
                
                document.getElementById('customQuiGroup').style.display = 'none';
                document.getElementById('submitBtn').textContent = '‚úèÔ∏è Modifier la demande';
                document.getElementById('cancelBtn').style.display = 'block';
                editingId = id;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function deleteDemande(id) {
            if (confirm('√ätes-vous s√ªr de vouloir supprimer cette demande ?')) {
                demandes = demandes.filter(d => d.id !== id);
                saveDemandes();
                renderDemandes();
            }
        }

        // ==================== IMPRESSION ====================
        function imprimerListe() {
            window.print();
        }

        // ==================== LANCEMENT ====================
        renderDemandes();
    </script>
</body>
</html>
